"use strict";angular.module("musique",["ngCookies","ngResource","ngSanitize","ngRoute","btford.socket-io"]).config(["$routeProvider","$sceDelegateProvider","$locationProvider","$httpProvider",function(a,b,c,d){var e=routingConfig.accessLevels;b.resourceUrlWhitelist(["self","**"]),a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",access:e.user}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl",access:e.public}).when("/profile",{templateUrl:"views/profile.html",controller:"ProfileCtrl",access:e.user}).when("/player",{templateUrl:"views/player.html",controller:"PlayerCtrl",access:e.user}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl",access:e.anon}).when("/register",{templateUrl:"views/register.html",controller:"RegisterCtrl",access:e.anon}).when("/private",{templateUrl:"views/private.html",controller:"PrivateCtrl",access:e.user}).when("/admin",{templateUrl:"views/admin.html",controller:"AdminCtrl",access:e.admin}).when("/404",{templateUrl:"views/404.html",access:e.public}).otherwise({redirectTo:"/404"}),c.html5Mode(!0),d.interceptors.push("httpInterceptor")}]).run(["$rootScope","$location","$http","Auth",function(a,b,c,d){a.$on("$routeChangeStart",function(c,e){a.error=null,d.authorize(e.access)||(d.isLoggedIn()?b.path("/"):b.path("/login"))}),a.currentTrack={}}]),angular.module("musique").directive("activeNav",["$location",function(a){return{restrict:"A",link:function(b,c){var d=c.find("a")[0],e=d.href;b.location=a,b.$watch("location.absUrl()",function(a){e===a?c.addClass("active"):c.removeClass("active")})}}}]),angular.module("musique").directive("accessLevel",["Auth",function(a){return{restrict:"A",link:function(b,c,d){function e(){f&&g&&(a.authorize(g,f)?c.css("display",h):c.css("display","none"))}var f,g,h=c.css("display");b.user=a.user,b.$watch("user",function(a){a.role&&(f=a.role),e()},!0),d.$observe("accessLevel",function(a){a&&(g=b.$eval(a)),e()})}}}]),angular.module("musique").factory("Auth",["$http","$cookieStore",function(a,b){function c(a){_.extend(f,a)}var d=routingConfig.accessLevels,e=routingConfig.userRoles,f=b.get("user")||{username:"",role:e.public};return b.remove("user"),{authorize:function(a,b){return void 0===b&&(b=f.role),a.bitMask&b.bitMask},isLoggedIn:function(a){return void 0===a&&(a=f),a.role.title==e.user.title||a.role.title==e.admin.title},register:function(b,d,e){a.post("//musique.pp.ua/register",b).success(function(a){c(a),d()}).error(e)},login:function(b,d,e){a.post("//musique.pp.ua/login",b).success(function(a){console.log(a),c(a),d(a)}).error(e)},logout:function(b,d){a.post("//musique.pp.ua/logout").success(function(){c({username:"",role:e.public}),b()}).error(d)},accessLevels:d,userRoles:e,user:f}}]),angular.module("musique").factory("Users",["$http",function(a){return{getAll:function(b,c){a.get("//localhost:3000/users").success(b).error(c)}}}]),angular.module("musique").factory("httpInterceptor",["$q","$location","$cookieStore",function(a,b,c){return{request:function(b){var d=c.get("user");return console.log("request - user",d),console.log("request - config",b),b||a.when(b)},requestError:function(c){return console.log("requestError - rejection",c),401===c.status||403===c.status?(b.path("/login"),a.reject(c)):a.reject(c)},response:function(b){return console.log("response - response",b),b||a.when(b)},responseError:function(c){return console.log("responseError - rejection",c),401===c.status||403===c.status?(b.path("/login"),a.reject(c)):a.reject(c)}}}]),angular.module("musique").controller("MainCtrl",["$rootScope",function(){}]),angular.module("musique").controller("NavigationCtrl",["$rootScope","$scope","$location","Auth",function(a,b,c,d){b.user=d.user,b.userRoles=d.userRoles,b.accessLevels=d.accessLevels,b.logout=function(){d.logout(function(){c.path("/login")},function(){a.error="Failed to logout"})}}]),angular.module("musique").controller("AboutCtrl",["$scope",function(){}]),angular.module("musique").controller("LoginCtrl",["$rootScope","$scope","$location","$window","Auth",function(a,b,c,d,e){b.rememberme=!0,b.login=function(){e.login({username:b.username,password:b.password,rememberme:b.rememberme},function(){c.path("/")},function(){a.error="Failed to login"})},b.loginOauth=function(a){d.location.href="//musique.pp.ua/auth/"+a}}]),angular.module("musique").controller("PlayerCtrl",["$scope","$rootScope","socket",function(a,b,c){a.search=null;var d=function(a){console.log(a),a&&c.emit("search-tracks",{query:a},function(a){console.log("PlayerCtrl - search-tracks - data",a)})};c.forward("search-tracks-result",a),a.$on("socket:search-tracks-result",function(b,c){console.log("PlayerCtrl - search-tracks-results - ev",b),console.log("PlayerCtrl - search-tracks-results - data",c),c.success&&(a.tracks=c.tracks)});var e=function(){var b=a.queue.shift(),d=b.id;c.emit("get-track-link",{trackId:d},function(a){console.log("PlayerCtrl - get-track-link - data",a)})};a.playQueue=e,a.getTracks=d,c.forward("get-track-link-result",a),a.$on("socket:get-track-link-result",function(a,c){console.log("PlayerCtrl - get-track-link-results - ev",a),console.log("PlayerCtrl - get-track-link-results - data",c),c.success&&(b.currentTrack=c.track)}),a.queue=[];var f=function(b){var c=null;for(var d in a.tracks)if(a.tracks[d].id===b){c=a.tracks[d];break}if(console.log(c),c){for(var e in a.queue)if(a.queue[e].id===b)return;c.rating=0,a.queue.push(c)}},g=function(b){var c=null;for(var d in a.queue)if(a.queue[d].id===b){c=a.queue[d];break}console.log(c),c&&a.queue[d].rating++},h=function(b){var c=null;for(var d in a.queue)if(a.queue[d].id===b){c=a.queue[d];break}console.log(c),c&&c.rating>0&&a.queue[d].rating--},i=function(b){var c=null;for(var d in a.queue)if(a.queue[d].id===b){c=a.queue[d];break}console.log(c),c&&delete a.queue[d]};a.addTrackToQueue=f,a.upVote=g,a.downVote=h,a.removeTrackFromQueue=i,a.$on("ended",function(a,c){console.log("PlayerCtrl - get-track-link-results - ev",a),console.log("PlayerCtrl - get-track-link-results - data",c),c.success&&(b.currentTrack=c.track)})}]),angular.module("musique").controller("ProfileCtrl",["$scope","$rootScopefunction",function(a,b){a.user=b.user}]);